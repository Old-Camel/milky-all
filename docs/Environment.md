# Environment

## 关于配置的一些思考

### 1.配置格式

* key/value类型。key/value是最简单的配置形式，也是最重要的形式。常见的配置方式如 `Propertis` 加载 `application.properties` 格式文件。
* group类型。比较复杂的场景可能是多个配置一起协作，形成依赖，多个配置形成一组配置。在做配置解析和校验的时候希望能够一起处理。
* list类型。针对同一个key需要多个value。
* affix类型。携带有 `prefix` 和 `suffix`。

### 2.配置文件

* `properties`。支持基于string类型的key/value类型配置。
* `xml`。支持层级配置或者有强 `schema` 的配置。`xml` 对于树形的配置支持能力非常好，配合 `xsd` 和 `dtd` 的约束文件能够借助工具在配置阶段实现自动提示、补全和错误纠正，同时可以在配置阶段就能提前发现问题。
* `json` 或 类 `json`。`json` 和 `xml` 同样能够作为数据传输格式，`xml` 支持的树形能力，`json` 也能很好支持。但是 `json` 的 `schema` 的推广效果不如 `xml`，在开发者中的反响弱很多。
* 数据库/zookeeper。远程配置。

### 3.配置安全

对于一些关键配置，不希望开发者能够轻易看到，只希望服务器感知和解析，像 `SSL` 的密钥。

对于安全需求，有两种处理方式。方式一是添加配置拦截器，在加载配置时使用内置的功能解码出配置文件中的加密数据供服务器使用。方式二是使用加密的存储，使开发者不能自由地浏览配置数据，如使用 `keystore`等。

### 4.配置更新

配置是否支持更新功能，允许更新的配置如何监听配置变动并及时更新配置。

比如数据库配置，这些配置一般在服务器运行期间不需要支持自动更新。但是像ab实验参数、限流等 `fault tolerate` 配置希望支持自动更新而不需要重新打包启动服务器。

### 5.配置的作用域

有些配置属于启动配置，只在启动阶段生效。而有些配置是在服务器运行期间生效，发挥作用的。在分布式环境中，有些配置是集群级别的，有些配置是 `node`、`shard` 或 `breaker`级别等等。

### 6.配置加载时机

服务器在不同的生命周期可能需要不同的配置，在不同阶段需要执行不同的配置加载动作。如服务器启动前加载、初始化阶段加载、运行阶段加载，甚至在宕机的时候导出配置。

### 7.配置导出功能

配置错误也是属于常见的易犯错误。开发者时常会疑问我的配置是否被服务器正确加载和解析？在动态更新配置后如何检查配置变更生效？当服务器发生异常时，开发者希望了解服务器的运行期间生效的配置辅助排查问题。

当新的特性在测试或者灰度环境经过验证后，除了发布分支代码到线上环境外，也需要在线上环境更新配置。而更新配置往往会被遗忘或者配置错误，能不能直接把经过验证的配置同步到线上呢？通过配置导出功能就可以实现配置在不同环境间的迁移。

### 8.配置缺省值

为了系统的健壮性以便在配置缺失时能够正常工作，开发者往往会提供一个缺省值。同时约定大于配置的思想盛行，很多软件都做到了开箱即用，对于初次使用者无需了解复杂的配置简化入门门槛，针对专家级使用者提供配置项进行调优工作。

在设置缺省值也可以做到精致。如果系统有多个配置源都支持同一项配置，有的配置源接近系统底层，而有的贴近用户使用，那么该考虑在哪一层为配置添加缺省值。

### 9.多配置源

* 配置覆盖。如果有多个配置源都支持同一项配置，该如何处理配置覆盖问题？比如在一个`springboot`与`apollo`的应用中，`application.yml`和`apollo`配置的优先级是怎么样的？
* 配置继承。一些通用的配置项如超时配置，支持全局配置，也支持细粒度的配置，如果细粒度没有配置则使用全局的配置。比如集群级别设置响应的超时时间，如果某个节点、topic、索引或table设置了自己的响应超时时间。
* 配置顺序和优先级。比如对于`SystemProperties`、`System#getenv(String)`、`application.yml`等配置源它们的加载顺序如何，优先级如何？

### 10.配置前后版本兼容

有些配置随着系统迭代，变成过期配置，如何正确标记这些过期配置在支持向后兼容的情况同时能够给出信息提示建议用户切换至新的配置项。

或者提供配置升级功能，对于旧版本的配置值经过处理后可以支持新版本的配置需求。

### 11.配置风格

在设计配置项的时候最好能够遵循统一的风格。如启用某项配置，有两种风格。方式一是提供专门的启用禁用标识，如 `disabled, enable` 或 `flag`，只有在配置启用或禁用的情况下才会处理。方法二是提供一个非法值，比如对于缓存size的配置，如果配置值为`-1`则代表无上限，对于`10`则表示缓存size上限为10。

### 12.占位符和应用解析

如果一个配置值需要在多个配置项中使用，那么它出错的概率会大大增加。

配置是否能够支持占位符解析，自动解析应用的配置并填入？